---
# Akash SDL - SSL Proxy (Pingap)
#
# Pingap-based SSL termination proxy with automatic Let's Encrypt certificates.
# Uses DNS-01 challenges via Cloudflare API.
# Built on Cloudflare's Pingora framework for high performance.
#
# This proxy handles SSL for all AlternateFutures services.
# Backend services should be deployed separately and referenced by their
# Akash ingress URLs in pingap.toml.
#
# Required env:
#   - PINGAP_DNS_SERVICE_URL: Cloudflare API URL with token
#
# Current Deployment:
#   DSEQ: 24576255
#   Provider: Europlots (akash162gym3szcy9d993gs3tyu0mg2ewcjacen9nwsu)

version: "2.0"

services:
  ssl-proxy:
    image: ghcr.io/alternatefutures/infrastructure-proxy-pingap:main
    expose:
      # HTTPS traffic
      - port: 443
        as: 443
        to:
          - global: true
        accept:
          - auth.alternatefutures.ai
          - api.alternatefutures.ai
          - app.alternatefutures.ai
      # Health check endpoint
      - port: 8080
        as: 8080
        to:
          - global: true
    env:
      # Cloudflare API for DNS-01 Let's Encrypt challenges
      # Format: https://api.cloudflare.com?token=<CF_API_TOKEN>
      - PINGAP_DNS_SERVICE_URL=${PINGAP_DNS_SERVICE_URL}

profiles:
  compute:
    ssl-proxy:
      resources:
        cpu:
          units: 0.25
        memory:
          size: 256Mi
        storage:
          - size: 256Mi

  placement:
    akash:
      attributes:
        host: akash
      signedBy:
        anyOf:
          - "akash1365yvmc4s7awdyj3n2sav7xfx76adc6dnmlx63"
      pricing:
        ssl-proxy:
          denom: uakt
          amount: 1000

deployment:
  ssl-proxy:
    akash:
      profile: ssl-proxy
      count: 1
